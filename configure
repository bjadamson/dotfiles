#!/usr/bin/env python2.7
import os, errno, shutil, sys
from setup import emacs, install, work, vim

def symlink_dotfile_to_target(prefix, homedir, dotfile, target):
    def os_symlink(target, destination):
        cmd = 'ln -s {0} {1}'.format(target, destination)
        print "executing cmd:{0}".format(cmd)
        os.system(cmd)
    def force_symlink(target, destination):
        try:
            os_symlink(target, destination)
        except OSError, e:
            if e.errno == errno.EEXIST:
                try:
                    os.remove(destination)
                    os_symlink(target, destination)
                except OSError, e:
                    if e.errno == errno.EISDIR:
                        shutil.rmtree(destination)
                        os_symlink(target, destination)

    dst = homedir + dotfile
    if os.path.islink(dst):
        val = os.unlink(dst)
    val = force_symlink(prefix + target, dst)
    print "val '" + str(val) + "'"

def create_directories(prefix, homedir):
    # Ensure '.config' directory exists in user directory.
    os.system('mkdir -p ~/.config')

    # This is a bit out of place, but for a REASON.
    # This symlink points to a directory, and line after this installs bundle into
    # the ~/.vim/bundle directory. If we don't create this symlink first, then the command on the
    # next line ends up creating the directory, removing the possibility of overriding it with this
    # symlink.
    # TL;DR: Just leave the order and shit works. :)
    symlink_dotfile_to_target(prefix, homedir, '.vim', '/vim/')
    os.system('mkdir -p ~/.vim/bundle')

def install_everything():
    install.system_dependency('git')
    install.system_dependency('fish')
    install.system_dependency('clisp')
    emacs.install_emacs()

def symlink_directories(prefix, homedir):
    def symlink_gitconfig(prefix, homedir):
        # Here we remove the .gitconfig file, so we can replace it with a symlink to this repo.
        fname = homedir + '/.gitconfig'
        os.system('rm -f %s' % fname)
        symlink_dotfile_to_target(prefix, homedir, '.gitconfig', '/git/gitconfig')

    # It's important to setup this symlink before we clone the vundles.
    symlink_dotfile_to_target(prefix, homedir, '.vim/', '/vim/')
    symlink_gitconfig(prefix, homedir)

    # Symlink the rest of the things.
    symlink_dotfile_to_target(prefix, homedir, '.config/fish', '/fish')
    symlink_dotfile_to_target(prefix, homedir, '.config/amethyst', '/amethyst')
    symlink_dotfile_to_target(prefix, homedir, '.emacs', '/emacs/.emacs')
    symlink_dotfile_to_target(prefix, homedir, '.vim', '/vim/')
    symlink_dotfile_to_target(prefix, homedir, '.zshrc', '/zsh/zshrc')

def write_zsh_file(dotfiles_directory):
    with open(dotfiles_directory + '/zshrc', 'w') as f:
        line1 = "export ZSH_DOTFILES=$HOME/Downloads/dotfiles/zsh/"
        line2 = "source $ZSH_DOTFILES/main"
        f.write(line1 + "\n")
        f.write(line2 + "\n")

def main(argv):
    """AFTER the symlink to the vim directory has been created, we can then only clone the vundle
    package.
    """
    """The only ordering that matters here is that the VIM symlink is created before we clone the vundle package.
    """
    prefix = sys.path[0]
    homedir = os.path.expanduser("~") + "/"
    dotfiles_directory = os.environ['ZSH_DOTFILES']

    create_directories(prefix, homedir)
    symlink_directories(prefix, homedir)
    write_zsh_file(dotfiles_directory)
    vim.clone_vundle(homedir)
    install_everything()


    if work.is_amazon_hostname(homedir):
        work.initialize_for_amazon_host(homedir, dotfiles_directory)
    print "Done"

main(sys.argv)
