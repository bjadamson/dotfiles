#!/usr/bin/env python2.7
import os, errno, shutil, sys
from setup import emacs, install, work, vim

def symlink_dotfile_to_target(prefix, homedir, dotfile, target):
    def force_symlink(file1, file2):
        try:
            os.symlink(file1, file2)
        except OSError, e:
            if e.errno == errno.EEXIST:
                try:
                    os.remove(file2)
                    os.symlink(file1, file2)
                except OSError, e:
                    if e.errno == errno.EISDIR:
                        shutil.rmtree(file2)
                        os.symlink(file1, file2)

    dst = homedir + '/' + dotfile
    if os.path.islink(dst):
        val = os.unlink(dst)
    val = force_symlink(prefix + target, dst)
    print "val '" + str(val) + "'"


def create_directories():
    # Ensure '.config' directory exists in user directory.
    os.system('mkdir -p ~/.config')
    os.system('mkdir -p ~/.vim/bundle')
    os.system('mkdir -p ~/.config/zsh/')


def install_everything():
    install.system_dependency('git')
    install.system_dependency('fish')
    install.system_dependency('clisp')
    emacs.install_emacs()

def symlink_directories(prefix, homedir):
    def symlink_gitconfig(prefix, homedir):
        # Here we remove the .gitconfig file, so we can replace it with a symlink to this repo.
        fname = homedir + '/.gitconfig'
        os.system('rm -f %s' % fname)
        symlink_dotfile_to_target(prefix, homedir, '.gitconfig', '/git/gitconfig')

    # It's important to setup this symlink before we clone the vundles.
    symlink_dotfile_to_target(prefix, homedir, '.vim', '/vim')
    symlink_gitconfig(prefix, homedir)

    # Symlink the rest of the things.
    symlink_dotfile_to_target(prefix, homedir, '.config/fish', '/fish')
    symlink_dotfile_to_target(prefix, homedir, '.config/amethyst', '/amethyst')
    symlink_dotfile_to_target(prefix, homedir, '.emacs', '/emacs/.emacs')
    symlink_dotfile_to_target(prefix, homedir, '.vimrc', '/vim/vimrc')
    symlink_dotfile_to_target(prefix, homedir, '.zshrc', '/zshrc/zshrc')

def main(argv):
    """AFTER the symlink to the vim directory has been created, we can then only clone the vundle
    package.
    """
    """The only ordering that matters here is that the VIM symlink is created before we clone the vundle package.
    """
    prefix = sys.path[0]
    homedir = os.path.expanduser("~")

    create_directories()
    symlink_directories(prefix, homedir)
    vim.clone_vundle(homedir)
    install_everything()

    if work.is_amazon_hostname(homedir):
        work.initialize_for_amazon_host(homedir)
    print "Done"

main(sys.argv)
